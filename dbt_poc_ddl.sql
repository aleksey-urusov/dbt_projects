-- Create database and schemas
CREATE DATABASE IF NOT EXISTS ANALYTICS_DB;
CREATE SCHEMA IF NOT EXISTS ANALYTICS_DB.BRONZE;
CREATE SCHEMA IF NOT EXISTS ANALYTICS_DB.SILVER;
CREATE SCHEMA IF NOT EXISTS ANALYTICS_DB.GOLD;

-- Bronze raw tables
CREATE OR REPLACE TABLE ANALYTICS_DB.BRONZE.RAW_ORDERS (
    ORDER_ID VARCHAR,
    CUSTOMER_ID VARCHAR,
    ORDER_DATE STRING,
    AMOUNT STRING,
    STATUS VARCHAR
);

CREATE OR REPLACE TABLE ANALYTICS_DB.BRONZE.RAW_CUSTOMERS (
    CUSTOMER_ID VARCHAR,
    CUSTOMER_NAME VARCHAR,
    EMAIL STRING,
    SIGNUP_DATE STRING
);

-- Sample raw data
INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD001', 'CUST001', '2025-12-01', '100.50', 'completed'),
('ORD002', 'CUST002', '2025-12-01', '200', 'completed'),
('ORD003', 'CUST001', '2025-12-02', '150.75', 'pending'),
('ORD004', 'CUST003', '2025-12-03', NULL, 'completed'),
('ORD005', 'CUST002', '2025-12-03', '50.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_CUSTOMERS VALUES
('CUST001', 'Alice Smith', 'alice@example.com', '2025-01-01'),
('CUST002', 'Bob Johnson', 'bob@invalid', '2025-02-15'),
('CUST003', 'Charlie Brown', NULL, '2025-03-20');
('CUST003', 'Charlie Brown', NULL, '2025-03-20');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_CUSTOMERS VALUES
('CUST004', 'JD Vance', 'alice@example.com', '2024-01-01'),
('CUST005', 'Bob the Gmail', 'bob@gmai.com', '2023-02-15'),
('CUST006', 'Hamalla Karris', 'stupid@bitch.com', '2023-03-20'),
('CUST007', 'N the N', 'n@n.com','2025-03-20');



INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD007', 'CUST001', '2025-12-15', '100.50', 'completed'),
('ORD008', 'CUST002', '2025-12-15', '200', 'completed'),
('ORD009', 'CUST001', '2025-12-15', '150.75', 'pending'),
('ORD010', 'CUST003', '2025-12-10', '300.00', 'completed'),
('ORD011', 'CUST002', '2025-12-10', '50.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD012', 'CUST002', '2025-12-16', '100.50', 'completed'),
('ORD013', 'CUST003', '2025-12-16', '200', 'completed'),
('ORD014', 'CUST001', '2025-12-14', '150.75', 'pending'),
('ORD015', 'CUST003', '2025-12-12', '300.00', 'completed'),
('ORD016', 'CUST002', '2025-12-12', '50.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD017', 'CUST002', '2025-12-14', '100.50', 'completed'),
('ORD018', 'CUST003', '2025-12-14', '200', 'completed'),
('ORD019', 'CUST001', '2025-12-14', '150.75', 'pending'),
('ORD020', 'CUST003', '2025-12-17', '300.00', 'completed'),
('ORD021', 'CUST002', '2025-12-17', '330.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD022', 'CUST004', '2025-12-14', '100.99', 'completed'),
('ORD023', 'CUST005', '2025-12-14', '199.99', 'completed'),
('ORD024', 'CUST006', '2025-12-14', '140.75', 'pending'),
('ORD025', 'CUST007', '2025-12-17', '15000.00', 'completed'),
('ORD026', 'CUST0042', '2025-12-17', '11.33', 'completed');




select * from ANALYTICS_DB.GOLD.DAILY_SALES_SUMMARY

---ALTER DYNAMIC TABLE ANALYTICS_DB.GOLD.DAILY_SALES_SUMMARY REFRESH;

---this plus 5 minute lag in the dbt_project table refreshes the GOLD dynamic table
EXECUTE DBT PROJECT ANALYTICS_DB.SILVER.ANALYTICS_SILVER ARGS = 'run --select stg_orders stg_customers';
