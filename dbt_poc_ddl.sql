-- Create database and schemas
CREATE DATABASE IF NOT EXISTS ANALYTICS_DB;
CREATE SCHEMA IF NOT EXISTS ANALYTICS_DB.BRONZE;
CREATE SCHEMA IF NOT EXISTS ANALYTICS_DB.SILVER;
CREATE SCHEMA IF NOT EXISTS ANALYTICS_DB.GOLD;

-- Bronze raw tables
CREATE OR REPLACE TABLE ANALYTICS_DB.BRONZE.RAW_ORDERS (
    ORDER_ID VARCHAR,
    CUSTOMER_ID VARCHAR,
    ORDER_DATE STRING,
    AMOUNT STRING,
    STATUS VARCHAR
);

CREATE OR REPLACE TABLE ANALYTICS_DB.BRONZE.RAW_CUSTOMERS (
    CUSTOMER_ID VARCHAR,
    CUSTOMER_NAME VARCHAR,
    EMAIL STRING,
    SIGNUP_DATE STRING
);

-- Sample raw data

INSERT INTO ANALYTICS_DB.BRONZE.RAW_CUSTOMERS VALUES
('CUST001', 'Alice Smith', 'alice@example.com', '2025-01-01'),
('CUST002', 'Bob Johnson', 'bob@invalid', '2025-02-15'),
('CUST003', 'Charlie Brown', 'cb@valid', '2025-03-20'),
('CUST004', 'JD Vance', 'alice@example.com', '2024-01-01'),
('CUST005', 'Bob the Gmail', 'bob@gmai.com', '2023-02-15'),
('CUST006', 'Hamalla Karris', 'stupid@bitch.com', '2023-03-20'),
('CUST007', 'N the N', 'n@n.com','2025-03-20');


INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD001', 'CUST001', '2025-12-01', '100.50', 'completed'),
('ORD002', 'CUST002', '2025-12-01', '200', 'completed'),
('ORD003', 'CUST001', '2025-12-02', '150.75', 'pending'),
('ORD004', 'CUST003', '2025-12-03', NULL, 'completed'),
('ORD005', 'CUST002', '2025-12-03', '50.00', 'completed');


INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD007', 'CUST001', '2025-12-15', '100.50', 'completed'),
('ORD008', 'CUST002', '2025-12-15', '200', 'completed'),
('ORD009', 'CUST001', '2025-12-15', '150.75', 'pending'),
('ORD010', 'CUST003', '2025-12-10', '300.00', 'completed'),
('ORD011', 'CUST002', '2025-12-10', '50.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD012', 'CUST002', '2025-12-16', '100.50', 'completed'),
('ORD013', 'CUST003', '2025-12-16', '200', 'completed'),
('ORD014', 'CUST001', '2025-12-17', '150.75', 'pending'),
('ORD015', 'CUST003', '2025-12-17', '300.00', 'completed'),
('ORD016', 'CUST002', '2025-12-17', '50.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD017', 'CUST002', '2025-12-18', '100.50', 'completed'),
('ORD018', 'CUST003', '2025-12-18', '200', 'completed'),
('ORD019', 'CUST001', '2025-12-18', '150.75', 'pending'),
('ORD020', 'CUST003', '2025-12-19', '300.00', 'completed'),
('ORD021', 'CUST002', '2025-12-19', '330.00', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD022', 'CUST004', '2025-12-20', '100.99', 'completed'),
('ORD023', 'CUST005', '2025-12-20', '199.99', 'completed'),
('ORD024', 'CUST006', '2025-12-20', '140.75', 'pending'),
('ORD025', 'CUST007', '2025-12-20', '15000.00', 'completed'),
('ORD026', 'CUST0042', '2025-12-20', '11.33', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD027', 'CUST001', '2025-12-21', '100.99', 'completed'),
('ORD028', 'CUST005', '2025-12-22', '199.99', 'completed'),
('ORD029', 'CUST002', '2025-12-21', '140.75', 'completed'),
('ORD030', 'CUST007', '2025-12-22', '15000.00', 'completed'),
('ORD031', 'CUST004', '2025-12-21', '11.33', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD035', 'CUST005', '2025-12-23', '150.99', 'completed'),
('ORD036', 'CUST005', '2025-12-23', '179.99', 'completed'),
('ORD037', 'CUST006', '2025-12-23', '14.75', 'completed'),
('ORD038', 'CUST007', '2025-12-24', '1000.00', 'completed'),
('ORD039', 'CUST008', '2025-12-24', '111.33', 'completed');

INSERT INTO ANALYTICS_DB.BRONZE.RAW_ORDERS VALUES
('ORD035', 'CUST001', '2025-12-25', '140.99', 'completed'),
('ORD036', 'CUST001', '2025-12-25', '129.99', 'completed'),
('ORD037', 'CUST004', '2025-12-25', '114.75', 'completed'),
('ORD038', 'CUST004', '2025-12-25', '100.00', 'completed'),
('ORD039', 'CUST004', '2025-12-25', '1.33', 'completed');

select * from ANALYTICS_DB.GOLD.DAILY_SALES_SUMMARY;
select * from ANALYTICS_DB.SILVER.STG_ORDERS;
select * from ANALYTICS_DB.SILVER.STG_CUSTOMERS;
select * from ANALYTICS_DB.BRONZE.RAW_ORDERS;
select * from ANALYTICS_DB.BRONZE.RAW_CUSTOMERS;

---ALTER DYNAMIC TABLE ANALYTICS_DB.GOLD.DAILY_SALES_SUMMARY REFRESH;

---this plus 5 minute lag in the dbt_project table refreshes the GOLD dynamic table
EXECUTE DBT PROJECT ANALYTICS_DB.SILVER.ANALYTICS_SILVER ARGS = 'run --select stg_orders stg_customers';
ALTER TABLE ANALYTICS_DB.SILVER.STG_ORDERS SET CHANGE_TRACKING = TRUE;
ALTER TABLE ANALYTICS_DB.SILVER.STG_CUSTOMERS SET CHANGE_TRACKING = TRUE;

SHOW TABLES LIKE 'STG_ORDERS' IN ANALYTICS_DB.SILVER;
SHOW TABLES LIKE 'STG_CUSTOMERS' IN ANALYTICS_DB.SILVER;

--adding GOLD project
EXECUTE DBT PROJECT ANALYTICS_DB.GOLD.ANALYTICS_GOLD ARGS     = 'run --full-refresh --select daily_sales_summary';

SELECT *
FROM TABLE(INFORMATION_SCHEMA.DYNAMIC_TABLE_REFRESH_HISTORY(
    NAME => 'ANALYTICS_DB.GOLD.DAILY_SALES_SUMMARY'))
ORDER BY REFRESH_START_TIME DESC;

SELECT *
FROM TABLE(INFORMATION_SCHEMA.DYNAMIC_TABLE_REFRESH_HISTORY(
    NAME => 'ANALYTICS_DB.SILVER.STG_CUSTOMERS'))
ORDER BY REFRESH_START_TIME DESC;

SELECT *
FROM TABLE(INFORMATION_SCHEMA.DYNAMIC_TABLE_REFRESH_HISTORY(
    NAME => 'ANALYTICS_DB.SILVER.STG_ORDERS'))
ORDER BY REFRESH_START_TIME DESC;


select current_time()

/*
truncate table  ANALYTICS_DB.BRONZE.RAW_ORDERS;
truncate table  ANALYTICS_DB.BRONZE.RAW_CUSTOMERS;
truncate table  ANALYTICS_DB.SILVER.STG_CUSTOMERS;
truncate table  ANALYTICS_DB.SILVER.STG_ORDERS;
*/
